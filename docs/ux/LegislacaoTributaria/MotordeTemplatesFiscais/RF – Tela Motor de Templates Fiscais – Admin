# RF ‚Äì Tela Motor de Templates Fiscais ‚Äì Admin

## 1. Objetivo

Disponibilizar, no **Painel de Administra√ß√£o**, uma tela √∫nica para:

- **Consultar, criar, editar, clonar e desativar** templates fiscais (`fiscal_template`);
- **Manter regras fiscais** associadas a cada template (`fiscal_template_regra`);
- **Visualizar a auditoria** de altera√ß√µes realizadas no motor de templates (`auditoria_fiscal_template`).

A tela deve ser focada em **simplicidade e produtividade**, permitindo que um usu√°rio administrativo configure as l√≥gicas fiscais que ser√£o usadas pelo Motor de Templates Fiscais no c√°lculo de tributos e na sugest√£o de CFOP/CST/CSOSN/aliquotas.

---

## 2. Escopo

### 2.1. Incluso

- Listagem e filtro de **templates fiscais**.
- A√ß√µes sobre templates:
  - Criar novo template;
  - Editar cabe√ßalho de template;
  - Clonar template;
  - Ativar/Inativar template;
  - Criar nova vers√£o de um template existente.
- Visualiza√ß√£o e manuten√ß√£o das **regras fiscais** associadas ao template selecionado.
- Visualiza√ß√£o da **auditoria** (hist√≥rico de altera√ß√µes) dos templates e regras.

### 2.2. Fora de escopo (nesta vers√£o)

- Exportar/importar templates em massa (CSV/Excel/JSON).
- Compara√ß√£o visual de vers√µes de templates.
- Visualiza√ß√£o avan√ßada de ‚Äúdiff‚Äù entre `dados_anteriores` e `dados_novos`.
- Configura√ß√µes avan√ßadas de heran√ßa/composi√ß√£o entre templates.

---

## 3. Atores

- **Admin Fiscal**  
  Usu√°rio com permiss√£o para administrar templates fiscais, regimes, segmentos e regras por NCM/UF/Opera√ß√£o.

- **Admin Sistema / Suporte**  
  Usu√°rio t√©cnico que pode atuar em ajustes e corre√ß√µes de templates em produ√ß√£o.

---

## 4. Localiza√ß√£o no sistema

Menu lateral:

> **Administra√ß√£o ‚Üí Motor de Templates Fiscais**

Acesso √† tela principal:  
`/admin/motor-templates-fiscais` (URL apenas ilustrativa).

---

## 5. Estrutura geral da tela

A tela ser√° composta por tr√™s √°reas principais:

1. **Faixa de Filtros** (topo)
2. **Lista de Templates** (coluna esquerda, abaixo dos filtros)
3. **Painel de Detalhes do Template Selecionado** (coluna direita, com abas)

### 5.1. Faixa de filtros

Campos:

- **Regime tribut√°rio**  
  - Tipo: combo obrigat√≥rio/sele√ß√£o m√∫ltipla (configur√°vel)  
  - Origem: `dom_regime_tributario_cliente`  
  - Exibi√ß√£o: `descricao`

- **Segmento**  
  - Tipo: combo  
  - Origem: `dom_segmento_cliente`  
  - Exibi√ß√£o: `descricao`

- **UF origem**  
  - Tipo: combo de UFs (lista fixa ou tabela de dom√≠nio)  

- **UF destino**  
  - Tipo: combo de UFs  

- **NCM**  
  - Tipo: campo de texto com autocomplete  
  - Origem: `dom_ncm` (campo `ncm_codigo` + `descricao`)  

- **Opera√ß√£o fiscal**  
  - Tipo: combo  
  - Origem: `dom_operacao_fiscal`  
  - Exibi√ß√£o: `codigo - descricao`

- **Ativo?**  
  - Tipo: combo  
  - Valores: `Ativos`, `Inativos`, `Todos` (default: `Ativos`)

Bot√µes:

- **[Filtrar]**
- **[Limpar]**

#### Comportamento

- Ao clicar em **[Filtrar]**, o sistema filtra a lista de templates abaixo conforme os par√¢metros informados.
- Ao clicar em **[Limpar]**, o sistema:
  - Limpa todos os campos de filtro;
  - Recarrega a lista com um conjunto padr√£o (ex.: √∫ltimos templates criados ou todos os ativos).

---

### 5.2. Lista de templates (coluna esquerda)

#### 5.2.1. Cabe√ßalho da lista

- T√≠tulo: **Templates encontrados**
- Badge opcional exibindo a quantidade:
  - Ex.: `15 templates encontrados`
- Bot√£o principal:
  - **[+ Novo Template]**

#### 5.2.2. Grade de templates

Colunas m√≠nimas:

- `Nome`  
  - Ex.: ‚ÄúSN ‚Äì Varejo Mercado ‚Äì SP ‚Üí SP ‚Äì Venda interna NCM 22029900‚Äù
- `Regime`  
  - Ex.: ‚ÄúSimples Nacional‚Äù
- `Segmento`  
  - Ex.: ‚ÄúVarejo Mercado‚Äù
- `UF Origem`  
  - Ex.: ‚ÄúSP‚Äù
- `UF Destino`  
  - Ex.: ‚ÄúSP‚Äù
- `NCM`  
  - Ex.: ‚Äú22029900‚Äù
- `Opera√ß√£o`  
  - Ex.: ‚ÄúVENDA_INTERNA‚Äù
- `Vers√£o`  
  - Ex.: ‚Äú3‚Äù
- `Vig√™ncia`  
  - Ex.: ‚Äú01/01/2025 ‚Äì 31/12/2025‚Äù ou ‚Äúa partir de 01/01/2025‚Äù
- `Status`  
  - Ex.: ‚ÄúAtivo‚Äù / ‚ÄúInativo‚Äù
- `A√ß√µes`  
  - √çcones:
    - ‚úèÔ∏è Editar
    - üìÑ Clonar
    - ‚èπ Ativar/Inativar

#### 5.2.3. Comportamentos

- Clique simples em uma linha:
  - Seleciona o template e carrega os detalhes na coluna direita.
- Duplo clique:
  - Abre o modal de **Edi√ß√£o de Template**.
- Bot√£o **[+ Novo Template]**:
  - Abre modal de cria√ß√£o de cabe√ßalho de template (ver item 6.1).
- √çcone **Clonar**:
  - Abre modal de confirma√ß√£o, criando um novo template com:
    - Mesmo cabe√ßalho (permitindo ajustes antes de salvar);
    - Mesmas regras (`fiscal_template_regra` clonadas).
- √çcone **Ativar/Inativar**:
  - Alterna o status de `ativo` do template, com confirma√ß√£o.

---

### 5.3. Painel de detalhes do template selecionado (coluna direita)

Quando um template √© selecionado na lista, o painel direito exibe:

#### 5.3.1. Cabe√ßalho do painel de detalhes

Informa√ß√µes:

- Nome do template
- Regime / Segmento
- UF Origem ‚Üí UF Destino
- NCM
- Opera√ß√£o fiscal
- Vers√£o
- Vig√™ncia
- Status (Ativo/Inativo)

Exemplo:

> **SN ‚Äì Varejo Mercado ‚Äì SP ‚Üí SP ‚Äì Venda interna NCM 22029900**  
> Simples Nacional ¬∑ Varejo Mercado ¬∑ SP ‚Üí SP ¬∑ NCM 22029900 ¬∑ VENDA_INTERNA  
> Vers√£o 3 ¬∑ Vigente de 01/01/2025 a 31/12/2025 ¬∑ **Ativo**

Bot√µes no cabe√ßalho de detalhes:

- **[Editar cabe√ßalho]**
- **[Nova vers√£o]**

#### 5.3.2. Abas

- Aba 1: **Regras fiscais**
- Aba 2: **Auditoria**

---

## 6. Funcionalidades detalhadas

### 6.1. Cria√ß√£o / Edi√ß√£o de Template (cabe√ßalho)

Acessos:

- Bot√£o **[+ Novo Template]** na lista;
- Bot√£o **[Editar cabe√ßalho]** no painel de detalhes;
- Bot√£o **[Nova vers√£o]** no painel de detalhes.

Campos do modal:

- `Nome do template` (texto, obrigat√≥rio)
- `Regime tribut√°rio` (combo, obrigat√≥rio)
- `Segmento` (combo, obrigat√≥rio)
- `UF origem` (combo, obrigat√≥rio)
- `UF destino` (combo, obrigat√≥rio)
- `NCM` (autocomplete, obrigat√≥rio)
- `Opera√ß√£o fiscal` (combo, obrigat√≥rio)
- `Tipo de item fiscal` (combo ‚Äì `dom_tipo_item_fiscal`)
- `Vers√£o`  
  - Em cria√ß√£o: default = 1  
  - Em nova vers√£o: sugerir `vers√£o atual + 1`
- `Vig√™ncia in√≠cio` (data, obrigat√≥ria)
- `Vig√™ncia fim` (data, opcional)
- `Ativo` (checkbox, default: marcado)
- `Descri√ß√£o` (texto, opcional)

Bot√µes:

- **[Salvar]**
- **[Cancelar]**

Regras de neg√≥cio:

- RN-01: N√£o permitir **sobreposi√ß√£o de vig√™ncia** para o mesmo conjunto de:
  - Regime, segmento, UF origem, UF destino, NCM, opera√ß√£o, tipo_item_fiscal
  - e mesma vers√£o ativa.
- RN-02: N√£o permitir salvar sem campos obrigat√≥rios.
- RN-03: `Nova vers√£o` deve:
  - Sugerir a mesma configura√ß√£o do template atual, alterando somente `vers√£o` e intervalo de vig√™ncia (deve ser ajustado pelo usu√°rio).

---

### 6.2. Aba ‚ÄúRegras fiscais‚Äù

Aba associada √†s entradas de `fiscal_template_regra` para o `template_id` selecionado.

#### 6.2.1. Grade de regras

Colunas:

- `CFOP` (c√≥digo + descri√ß√£o resumida)
- `CST ICMS` (c√≥digo + resumo)
- `CSOSN` (c√≥digo + resumo)
- `CST PIS`
- `CST COFINS`
- `Al√≠quota ICMS`
- `Al√≠quota PIS`
- `Al√≠quota COFINS`
- `Al√≠quota IPI`
- `Redu√ß√£o BC ICMS`
- `Modo c√°lculo ST`
- `Observa√ß√£o fiscal`
- `A√ß√µes` (‚úèÔ∏è Editar, üóë Excluir)

#### 6.2.2. A√ß√µes

- **[+ Adicionar regra]**
  - Abre modal de cria√ß√£o de regra.
- √çcone **Editar**:
  - Abre modal de edi√ß√£o da regra selecionada.
- √çcone **Excluir**:
  - Solicita confirma√ß√£o antes de excluir.

#### 6.2.3. Campos do modal de regra fiscal

- `CFOP` (combo/autocomplete ‚Äì origem: `dom_cfop`)
- `CST ICMS` (combo ‚Äì origem: `dom_cst_icms`)
- `CSOSN` (combo ‚Äì origem: `dom_sn_csosn`)
- `CST PIS` (combo ‚Äì origem: `dom_cst_pis`)
- `CST COFINS` (combo ‚Äì origem: `dom_cst_cofins`)
- `Al√≠quota ICMS` (num√©rico, opcional)
- `Al√≠quota PIS` (num√©rico, opcional)
- `Al√≠quota COFINS` (num√©rico, opcional)
- `Al√≠quota IPI` (num√©rico, opcional)
- `Redu√ß√£o BC ICMS` (num√©rico, opcional)
- `Modo c√°lculo ST` (combo simples ou texto curto)
- `Observa√ß√£o fiscal` (textarea)

Bot√µes:

- **[Salvar]**
- **[Cancelar]**

Regras de neg√≥cio:

- RN-04: Deve ser impedida a cria√ß√£o de **duplicidade de regra** para o mesmo template e mesmo CFOP, quando isso n√£o for desejado (pode ser parametriz√°vel).
- RN-05: Campos num√©ricos devem aceitar apenas valores v√°lidos (0‚Äì100 para al√≠quotas em %, por padr√£o).
- RN-06: Exclus√£o de regra deve exigir confirma√ß√£o.

---

### 6.3. Aba ‚ÄúAuditoria‚Äù

Exibe informa√ß√µes da tabela `auditoria_fiscal_template`, filtradas por:

- `template_id` igual ao template selecionado.
- E/ou `template_regra_id` das regras pertencentes ao template (implementa√ß√£o pode variar).

#### 6.3.1. Grade de auditoria

Colunas:

- `Data/Hora` (`data_evento`)
- `Usu√°rio` (`usuario`)
- `Origem` (`origem` ‚Äì UI, API, JOB, etc.)
- `Tipo entidade` (`tipo_entidade` ‚Äì TEMPLATE / REGRA)
- `Opera√ß√£o` (`operacao` ‚Äì INSERT / UPDATE / DELETE)
- `Resumo` (campo derivado, opcional; pode ser uma linha sint√©tica)

#### 6.3.2. A√ß√µes

- Clique em uma linha:
  - Abre modal com detalhes da auditoria:
    - `dados_anteriores` (JSON formatado)
    - `dados_novos` (JSON formatado)
    - Informa√ß√µes de contexto (usu√°rio, origem, data/hora, tipo, opera√ß√£o)

N√£o √© permitido:

- Editar registros de auditoria.
- Excluir registros de auditoria via UI.

---

## 7. Regras de neg√≥cio gerais

- RN-07: Todas as altera√ß√µes em `fiscal_template` e `fiscal_template_regra` devem gerar registro em `auditoria_fiscal_template` (via trigger ou camada de aplica√ß√£o).
- RN-08: Templates **inativos** n√£o devem ser sugeridos pelo Motor de Templates em novos c√°lculos fiscais.
- RN-09: N√£o √© permitido deletar fisicamente um template que j√° tenha sido utilizado em documentos fiscais (neste caso, apenas inativar).
- RN-10: Campos de dom√≠nio (regime, segmento, CFOP, CST etc.) devem ser selecionados exclusivamente a partir das respectivas tabelas `dom_*`, evitando valores livres.

---

## 8. Mensagens de erro e feedback ao usu√°rio

Exemplos:

- Ao salvar template com campos obrigat√≥rios faltando:
  - ‚ÄúPreencha todos os campos obrigat√≥rios.‚Äù
- Ao tentar sobrepor vig√™ncia:
  - ‚ÄúJ√° existe um template com o mesmo regime, segmento, UFs, NCM e opera√ß√£o dentro deste per√≠odo de vig√™ncia.‚Äù
- Ao excluir regra:
  - Confirma√ß√£o: ‚ÄúTem certeza que deseja excluir esta regra fiscal? Esta a√ß√£o n√£o poder√° ser desfeita.‚Äù
- Ao salvar com sucesso:
  - ‚ÄúTemplate fiscal salvo com sucesso.‚Äù
- Ao salvar regra com sucesso:
  - ‚ÄúRegra fiscal salva com sucesso.‚Äù

---

## 9. Seguran√ßa e permiss√µes

- Apenas usu√°rios com perfil **Admin Fiscal** ou permiss√£o equivalente podem:
  - Criar/editar/clonar/ativar/inativar templates;
  - Criar/editar/excluir regras fiscais.
- Usu√°rios sem permiss√£o podem ter acesso **somente leitura** √† tela (opcional, a definir).

---

## 10. Requisitos n√£o funcionais (n√≠vel UX)

- A tela deve ser responsiva, por√©m otimizada para uso em **desktop**.
- A busca por NCM deve ter autocomplete perform√°tico mesmo com grande volume de registros (uso de pagina√ß√£o, limite de resultados por busca).
- Filtros devem manter os valores selecionados ao navegar entre templates para facilitar ajustes iterativos.

---
